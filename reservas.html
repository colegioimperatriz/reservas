<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>v1.2 - Controle de Reservas</title>
<style>
  :root{
    --primary:#075E54;
    --accent:#25d366;
    --bg:#f0f0f0;
    --chromebooks:#1e88e5;
    --cozinha:#f39c12;
    --telesala:#2e7d32;
    --salaatendimento:#8e44ad;
    --salareunioes:#d35400;
    --bloqueio:#555;
  }
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:20px}
  .container{max-width:1200px;margin:0 auto}
  h2{text-align:center;margin:6px 0 12px}
  #topBar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.warn{background:#f39c12;color:#fff}
  .badge{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff}
  .badge.secondary{background:#888}
  .calendar{background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  table{border-collapse:collapse;width:100%}
  thead{background:var(--primary);color:#fff}
  th,td{border:1px solid #ddd;padding:6px;vertical-align:top;font-size:13px;min-width:110px;height:120px;position:relative}
  td{background:#e5ddd5}
  .reserva{display:block;padding:4px 6px;border-radius:6px;margin:4px 0;color:#fff;font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:default}
  .reserva.bloqueio{background:var(--bloqueio);opacity:0.95}
  /* cores por ambiente */
  .amb-Chromebooks{background:var(--chromebooks) !important}
  .amb-Cozinha{background:var(--cozinha) !important}
  .amb-TeleSala{background:var(--telesala) !important}
  .amb-SalaAtendimentoI{background:var(--salaatendimento) !important}
  .amb-SalaReunioes{background:var(--salareunioes) !important}

  .scroll-container{overflow-x:auto}
  .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:50;padding-top:40px}
  .modal-content{background:#fff;margin:20px auto;padding:16px;border-radius:8px;max-width:720px;position:relative}
  .close{position:absolute;right:12px;top:8px;font-size:22px;cursor:pointer;color:#666}
  .field{margin:8px 0}
  .field label{display:block;margin-bottom:6px;font-weight:600}
  input[type="date"], input[type="number"], select{padding:8px;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
  .option-container{display:flex;flex-wrap:wrap;gap:6px}
  .option-btn{padding:8px 10px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .option-btn.selected{background:#128c5e}
  .list-item{padding:8px;background:#fafafa;border-radius:6px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
  .del-btn{background:#d9534f;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  .small{font-size:13px;color:#333}
  .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .legend-item{display:flex;gap:6px;align-items:center;padding:6px 8px;background:#fff;border-radius:6px;border:1px solid #eee}
  .swatch{width:16px;height:16px;border-radius:4px;display:inline-block}

  /* tooltip */
  .tooltip{position:fixed;pointer-events:none;background:#111;color:#fff;padding:8px;border-radius:6px;font-size:13px;z-index:9999;opacity:0;transform:translateY(-6px);transition:opacity .12s,transform .12s;max-width:260px;box-shadow:0 6px 20px rgba(0,0,0,.2)}
  .tooltip.show{opacity:1;transform:translateY(0)}
  .tooltip b{display:block;margin-bottom:4px}
  @media (max-width:900px){ th,td{font-size:12px;min-width:90px;height:110px} }
</style>
</head>
<body>
<div class="container">
  <h2>Calendário de Reservas — Colégio Imperatriz</h2>

  <div id="topBar">
    <div class="controls">
      <button id="refreshBtn" class="btn primary">Atualizar</button>
      <button id="openManualBtn" class="btn warn">Liberar Manualmente</button>
    </div>

    <div id="totalsBar">
      <span class="badge">Total reservados (hoje): <strong id="totalReservados">0</strong></span>
      <span class="badge secondary">Total livres (hoje): <strong id="totalLivres">0</strong></span>
    </div>
  </div>

  <div class="legend" id="legend">
    <div class="legend-item"><span class="swatch" style="background:var(--chromebooks)"></span> Chromebooks</div>
    <div class="legend-item"><span class="swatch" style="background:var(--cozinha)"></span> Cozinha</div>
    <div class="legend-item"><span class="swatch" style="background:var(--telesala)"></span> Tele Sala</div>
    <div class="legend-item"><span class="swatch" style="background:var(--salaatendimento)"></span> Sala de Atendimento I</div>
    <div class="legend-item"><span class="swatch" style="background:var(--salareunioes)"></span> Sala de Reuniões</div>
    <div class="legend-item"><span class="swatch" style="background:var(--bloqueio)"></span> Bloqueio Manual</div>
  </div>

  <div style="height:12px"></div>

  <div class="calendar">
    <div style="padding:8px 12px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px">
      <div id="calendarHeader" style="flex:1"></div>
    </div>

    <div class="scroll-container">
      <table>
        <thead>
          <tr id="theadRow"><th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th></tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>
  </div>

  <!-- modal detalhes -->
  <div id="reservationModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h3>Detalhes da Reserva</h3>
      <p><strong>Ambiente:</strong> <span id="modalAmbiente"></span></p>
      <p><strong>Professor:</strong> <span id="modalProfessor"></span></p>
      <p><strong>Data:</strong> <span id="modalData"></span></p>
      <p><strong>Horários:</strong> <span id="modalHorarios"></span></p>
      <p><strong>Quantidade:</strong> <span id="modalQuantidade"></span></p>
      <div id="modalPerHorario"></div>
      <div style="margin-top:12px;">
        <button id="cancelReservationBtn" class="btn primary">Cancelar Reserva</button>
      </div>
    </div>
  </div>

  <!-- modal liberar manualmente -->
  <div id="manualReleaseModal" class="modal">
    <div class="modal-content">
      <span id="closeManual" class="close">&times;</span>
      <h3>Liberação Manual de Recursos</h3>

      <div class="field">
        <label>Ambiente</label>
        <select id="manualAmbiente">
          <option>Chromebooks</option>
          <option>Cozinha</option>
          <option>Tele Sala</option>
          <option>Sala de Atendimento I</option>
          <option>Sala de Reuniões</option>
        </select>
      </div>

      <div class="field">
        <label>Data</label>
        <input type="date" id="manualDate" />
      </div>

      <div class="field">
        <label>Horários (selecione um ou mais)</label>
        <div id="manualHorarios" class="option-container"></div>
      </div>

      <div class="field">
        <label>Quantidade (por horário)</label>
        <input type="number" id="manualQuantidade" min="1" value="1" />
      </div>

      <div style="margin-top:8px;">
        <button id="confirmManual" class="btn primary">Confirmar liberação</button>
      </div>

      <hr style="margin:12px 0" />
      <h4>Bloqueios existentes</h4>
      <div id="bloqueiosList" class="small"></div>
    </div>
  </div>
</div>

<div id="tooltip" class="tooltip" aria-hidden="true"></div>

<script>
/* CONFIGURAÇÃO SUPABASE */
const SUPABASE_URL = "https://oufiieqxyyqnqpcbuyms.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const headers = { "Content-Type":"application/json", "apikey":SUPABASE_KEY, "Authorization":`Bearer ${SUPABASE_KEY}` };

const MAX_CHROMEBOOKS = 85;
const MAX_DEFAULT = 1;
const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];

let reservas=[], bloqueios=[], currentYear=new Date().getFullYear(), currentMonth=new Date().getMonth();

/* HELPERS */
function hojeStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function isoToBR(iso){ if(!iso) return '---'; return iso.split('T')[0].split('-').reverse().join('/'); }
function toArray(val){ if(!val) return []; if(Array.isArray(val)) return val; try{ return JSON.parse(val); }catch(e){ if(typeof val==='string') return val.split(',').map(s=>s.trim()).filter(Boolean); return []; } }

/* SUPABASE CALLS */
async function fetchReservas(){ try{ const r=await fetch(`${SUPABASE_URL}/rest/v1/reservas?select=*`,{headers}); if(!r.ok) return []; return await r.json(); }catch(e){ return []; } }
async function fetchBloqueios(){ try{ const r=await fetch(`${SUPABASE_URL}/rest/v1/bloqueios?select=*`,{headers}); if(!r.ok) return []; return await r.json(); }catch(e){ return []; } }
async function criarBloqueio(b){ try{ const r=await fetch(`${SUPABASE_URL}/rest/v1/bloqueios`,{method:'POST',headers,body:JSON.stringify(b)}); return r.ok? await r.json() : null; }catch(e){ return null; } }
async function criarReserva(r){ try{ const res = await fetch(`${SUPABASE_URL}/rest/v1/reservas`,{method:'POST',headers,body:JSON.stringify(r)}); return res.ok? await res.json() : null; }catch(e){ return null; } }
async function deleteReserva(id){ try{ await fetch(`${SUPABASE_URL}/rest/v1/reservas?id=eq.${id}`,{method:'DELETE',headers}); }catch(e){} }

/* CALENDAR */
async function montarCalendario(ano=currentYear, mes=currentMonth){
  currentYear=ano; currentMonth=mes;
  reservas = await fetchReservas(); bloqueios = await fetchBloqueios();

  const tbody=document.getElementById('calendarBody'); tbody.innerHTML='';
  const primeiroDia=new Date(ano,mes,1), ultimoDia=new Date(ano,mes+1,0), diasNoMes=ultimoDia.getDate();

  // header meses
  const header=document.getElementById('calendarHeader'); header.innerHTML='';
  const mesesDisponiveis = new Set([...reservas,...bloqueios].map(r=>{ const d=r.datafim||r.dataFim||''; if(!d) return null; const p=d.split('-'); return p.length>=2? `${p[0]}-${p[1].padStart(2,'0')}`: null;}).filter(Boolean));
  mesesDisponiveis.add(`${ano}-${String(mes+1).padStart(2,'0')}`);
  const select=document.createElement('select');
  Array.from(mesesDisponiveis).sort().forEach(val=>{
    const [y,m]=val.split('-'); const option=document.createElement('option'); option.value=val;
    option.textContent=`${new Date(Number(y),Number(m)-1).toLocaleString('pt-BR',{month:'long'})} ${y}`;
    if(Number(y)===ano && Number(m)-1===mes) option.selected=true;
    select.appendChild(option);
  });
  select.onchange=function(){ const [y,m]=this.value.split('-').map(Number); montarCalendario(y,m-1); };
  header.appendChild(select);

  // montar dias
  let tr=document.createElement('tr'); for(let i=0;i<primeiroDia.getDay();i++) tr.appendChild(document.createElement('td'));
  for(let dia=1;dia<=diasNoMes;dia++){
    if(tr.children.length===7){ tbody.appendChild(tr); tr=document.createElement('tr'); }
    const td=document.createElement('td'); const dataStr=`${ano}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
    const divDia=document.createElement('div'); divDia.style.fontWeight='bold'; divDia.textContent=dia; td.appendChild(divDia);

    // reservas
    reservas.filter(r=>{ const d=r.datafim||r.dataFim||''; return d && d.startsWith(dataStr); }).forEach(r=>{
      const arr=toArray(r.horarios); arr.forEach(h=>{
        const div=document.createElement('div'); div.classList.add('reserva','amb-'+(r.ambiente||'Chromebooks').replace(/\s+/g,'').replace(/[^a-zA-Z0-9]/g,''));
        div.innerText = r.ambiente==='Chromebooks'? `${h} ${r.professor} (${r.quantidade||1})`:`${h} ${r.ambiente} — ${r.professor}`;
        div.dataset.prof=r.professor||'---'; div.dataset.quant=r.quantidade||1; div.dataset.horarios=h; div.dataset.data=dataStr; div.dataset.ambiente=r.ambiente||'Chromebooks';
        div.addEventListener('mouseenter', showTooltip); div.addEventListener('mousemove', moveTooltip); div.addEventListener('mouseleave', hideTooltip);
        div.onclick = ()=> openModal(r);
        td.appendChild(div);
      });
    });

    // bloqueios manuais apenas
    bloqueios.filter(b=>{ const d=b.datafim||b.dataFim||''; return d && d.startsWith(dataStr) && b.professor==='Admin (manual)'; }).forEach(b=>{
      const arr=toArray(b.horarios); arr.forEach(h=>{
        const div=document.createElement('div'); div.classList.add('reserva','bloqueio');
        div.innerText=`${h} BLOQUEIO (${b.quantidade})`;
        div.dataset.prof=b.professor; div.dataset.quant=b.quantidade||0; div.dataset.horarios=h; div.dataset.data=dataStr; div.dataset.ambiente=b.ambiente||'Chromebooks';
        div.addEventListener('mouseenter', showTooltip); div.addEventListener('mousemove', moveTooltip); div.addEventListener('mouseleave', hideTooltip);
        td.appendChild(div);
      });
    });

    tr.appendChild(td);
  }
  while(tr.children.length<7) tr.appendChild(document.createElement('td'));
  tbody.appendChild(tr);

  atualizarTotaisDia();
}

/* TOTAIS */
function atualizarTotaisDia(){
  const hoje=hojeStr();
  let reservado=reservas.filter(r=>r.datafim.startsWith(hoje)).reduce((s,r)=>s+(Number(r.quantidade)||0),0);
  let bloqueado=bloqueios.filter(b=>b.datafim.startsWith(hoje)).reduce((s,b)=>s+(Number(b.quantidade)||0),0);
  document.getElementById('totalReservados').textContent=reservado+bloqueado;
  document.getElementById('totalLivres').textContent=Math.max(0, MAX_CHROMEBOOKS-(reservado+bloqueado));
}

/* MODAL DETALHES */
function openModal(r){
  document.getElementById('modalAmbiente').textContent=r.ambiente||'Chromebooks';
  document.getElementById('modalProfessor').textContent=r.professor||'---';
  document.getElementById('modalData').textContent=isoToBR(r.datafim||r.dataFim);
  document.getElementById('modalHorarios').textContent=toArray(r.horarios).join(', ');
  document.getElementById('modalQuantidade').textContent=r.quantidade||1;

  const perHorarioDiv=document.getElementById('modalPerHorario'); perHorarioDiv.innerHTML='';
  const counts = {};
  reservas.forEach(res=>{ toArray(res.horarios).forEach(h=>{ const key=`${res.datafim}-${res.ambiente}-${h}`; counts[key]=(counts[key]||0)+(Number(res.quantidade)||0); }); });
  bloqueios.forEach(b=>{ if(b.professor==='Admin (manual)') toArray(b.horarios).forEach(h=>{ const key=`${b.datafim}-${b.ambiente}-${h}`; counts[key]=(counts[key]||0)+(Number(b.quantidade)||0); }); });

  toArray(r.horarios).forEach(h=>{
    const key=`${r.datafim}-${r.ambiente}-${h}`;
    const reserved=counts[key]||0;
    const maxPermitido=(r.ambiente==='Chromebooks'?MAX_CHROMEBOOKS:MAX_DEFAULT);
    const free=Math.max(0,maxPermitido-reserved);
    const p=document.createElement('p'); p.innerHTML=`<strong>${h}:</strong> Reservados: ${reserved} — Livres: ${free}`;
    perHorarioDiv.appendChild(p);
  });

  const cancelBtn=document.getElementById('cancelReservationBtn');
  cancelBtn.onclick=async ()=>{
    if(confirm('Cancelar reserva?')){
      await deleteReserva(r.id);
      reservas=await fetchReservas();
      bloqueios=await fetchBloqueios();
      montarCalendario();
      document.getElementById('reservationModal').style.display='none';
    }
  };
  document.getElementById('reservationModal').style.display='block';
}
document.getElementById('closeModal').onclick = ()=> document.getElementById('reservationModal').style.display='none';

/* MODAL MANUAL */
const openManualBtn=document.getElementById('openManualBtn');
const manualModal=document.getElementById('manualReleaseModal');
const closeManual=document.getElementById('closeManual');
const manualHorarios=document.getElementById('manualHorarios');
const manualDate=document.getElementById('manualDate');
const manualQuantidade=document.getElementById('manualQuantidade');
const confirmManual=document.getElementById('confirmManual');
const bloqueiosList=document.getElementById('bloqueiosList');
const manualAmbiente=document.getElementById('manualAmbiente');

openManualBtn.onclick = async ()=>{
  manualHorarios.innerHTML='';
  horarios.forEach(h=>{ const btn=document.createElement('button'); btn.classList.add('option-btn'); btn.innerText=h; btn.dataset.h=h; btn.onclick=()=>btn.classList.toggle('selected'); manualHorarios.appendChild(btn); });
  manualDate.value=hojeStr(); manualQuantidade.value=1;
  await carregarBloqueios();
  manualModal.style.display='block';
};
closeManual.onclick=()=> manualModal.style.display='none';

async function carregarBloqueios(){
  bloqueios=await fetchBloqueios();
  bloqueiosList.innerHTML='';
  bloqueios.filter(b=>b.professor==='Admin (manual)').forEach(b=>{
    const div=document.createElement('div'); div.classList.add('list-item');
    const arr=toArray(b.horarios);
    div.textContent=`${isoToBR(b.datafim||b.dataFim)} — ${arr.join(', ')} — Qtde: ${b.quantidade} — ${b.ambiente||'Chromebooks'}`;
    const del=document.createElement('button'); del.textContent='Remover'; del.classList.add('del-btn');
    del.onclick=async ()=>{ if(confirm('Remover bloqueio?')){ await fetch(`${SUPABASE_URL}/rest/v1/bloqueios?id=eq.${b.id}`,{method:'DELETE',headers}); montarCalendario(); await carregarBloqueios(); } };
    div.appendChild(del); bloqueiosList.appendChild(div);
  });
}

/* LIBERAÇÃO MANUAL */
confirmManual.onclick=async ()=>{
  const selected = Array.from(manualHorarios.querySelectorAll('.selected')).map(b=>b.dataset.h);
  if(selected.length===0){ alert('Selecione ao menos um horário'); return; }
  const data=manualDate.value; const quantidade=parseInt(manualQuantidade.value)||1; const ambiente=manualAmbiente.value||'Chromebooks';

  reservas=await fetchReservas(); bloqueios=await fetchBloqueios();

  for(const h of selected){
    const ocupados = reservas.filter(r=>(r.ambiente||'Chromebooks')===ambiente && (r.datafim||r.dataFim)===data && toArray(r.horarios).includes(h)).reduce((s,r)=>s+(Number(r.quantidade)||0),0);
    const bloqueado = bloqueios.some(b=>(b.datafim||b.dataFim)===data && toArray(b.horarios).includes(h) && b.professor==='Admin (manual)' && (b.ambiente||'Chromebooks')===ambiente);
    const maxPermitido=(ambiente==='Chromebooks'?MAX_CHROMEBOOKS:MAX_DEFAULT);
    if(bloqueado){ alert(`O horário ${h} em ${isoToBR(data)} para ${ambiente} já está bloqueado.`); return; }
    if(ocupados+quantidade>maxPermitido){ alert(`Não é possível liberar ${quantidade} em ${h} — já existem ${ocupados} ocupados (máx: ${maxPermitido})`); return; }
  }

  for(const h of selected){
    await criarReserva({professor:'Admin (manual)', cpf:'000.000.000-00', telefone:'-', email:'-', datafim:data, horarios:[h], ambiente:ambiente, quantidade:quantidade});
    // criar bloqueio manual se atingir limite
    reservas=await fetchReservas();
    const ocupadosAgora=reservas.filter(r=>(r.ambiente||'Chromebooks')===ambiente && (r.datafim||r.dataFim)===data && toArray(r.horarios).includes(h)).reduce((s,r)=>s+(Number(r.quantidade)||0),0);
    if(ocupadosAgora=== (ambiente==='Chromebooks'?MAX_CHROMEBOOKS:MAX_DEFAULT)){
      const existeBloq = (await fetchBloqueios()).some(b=>(b.datafim||b.dataFim)===data && toArray(b.horarios).includes(h) && b.professor==='Admin (manual)' && (b.ambiente||'Chromebooks')===ambiente);
      if(!existeBloq) await criarBloqueio({datafim:data, horarios:[h], quantidade:ocupadosAgora, ambiente:ambiente, professor:'Admin (manual)'});
    }
  }

  alert('✅ Liberações manuais registradas com sucesso.');
  manualModal.style.display='none';
  montarCalendario();
  await carregarBloqueios();
};

/* REFRESH */
document.getElementById('refreshBtn').onclick = ()=> montarCalendario();

/* TOOLTIP */
const tooltip=document.getElementById('tooltip');
function showTooltip(e){ const el=e.currentTarget; tooltip.innerHTML=`<b>${el.dataset.ambiente}</b><div>${el.dataset.prof} — ${el.dataset.quant} unidade(s)</div><div>${el.dataset.horarios} • ${isoToBR(el.dataset.data)}</div>`; tooltip.classList.add('show'); moveTooltip(e); }
function moveTooltip(e){ const pad=12; let x=e.clientX+pad,y=e.clientY+pad; const rect=tooltip.getBoundingClientRect(); if(x+rect.width>window.innerWidth) x=e.clientX-rect.width-pad; if(y+rect.height>window.innerHeight) y=e.clientY-rect.height-pad; tooltip.style.left=x+'px'; tooltip.style.top=y+'px'; }
function hideTooltip(){ tooltip.classList.remove('show'); }

/* INICIA */
montarCalendario();
</script>
</body>
</html>
