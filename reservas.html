<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#075E54" />
<title>Controle de Reservas - Painel Administrador  ‚Äî Col√©gio Imperatriz</title>
<style>
  :root{
    --primary:#075E54;
    --accent:#25d366;
    --bg:#f0f0f0;
    --chromebooks:#1e88e5;
    --cozinha:#f39c12;
    --telesala:#2e7d32;
    --salaatendimento:#8e44ad;
    --salareunioes:#d35400;
    --carro:#6c757d;
    --labquimica:#00796b;
    --labfisica:#5d4037;
    --labiologia:#c2185b;
    --salactc:#3949ab;
    --bloqueio:#555;
    --muted:#777;
    --card-shadow: 0 6px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:20px;color:#222;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .container{max-width:1200px;margin:0 auto}
  h2{text-align:center;margin:6px 0 12px;font-weight:600}
  #topBar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
  .btn:focus{outline:3px solid rgba(7,94,84,.14);outline-offset:2px}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.warn{background:#f39c12;color:#fff}
  .btn.ghost{background:transparent;border:1px solid #ddd}
  .btn[disabled]{opacity:0.6;cursor:not-allowed}
  .badge{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;cursor:default}
  .badge.secondary{background:#888}
  .calendar{background:#fff;border-radius:8px;overflow:hidden;box-shadow:var(--card-shadow)}
  table{border-collapse:collapse;width:100%}
  thead{background:var(--primary);color:#fff}
  th,td{border:1px solid #ddd;padding:6px;vertical-align:top;font-size:13px;min-width:110px;min-height:110px;position:relative}
  td{background:#e5ddd5}
  .reserva{display:block;padding:4px 6px;border-radius:6px;margin:4px 0;color:#fff;font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:pointer}
  .reserva.bloqueio{background:var(--bloqueio);opacity:0.95}
  /* cores por ambiente (classes usadas quando poss√≠vel) */
  .amb-Chromebooks{background:var(--chromebooks) !important}
  .amb-Cozinha{background:var(--cozinha) !important}
  .amb-TeleSala{background:var(--telesala) !important}
  .amb-SalaDeAtendimentoI{background:var(--salaatendimento) !important}
  .amb-SalaDeReuni√µes{background:var(--salareunioes) !important}
  .amb-Carro{background:var(--carro) !important}
  .amb-LabQu√≠mica{background:var(--labquimica) !important}
  .amb-LabF√≠sica{background:var(--labfisica) !important}
  .amb-LabBiologia{background:var(--labiologia) !important}
  .amb-SalaDoCTC{background:var(--salactc) !important}

  .scroll-container{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
  .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:200;padding-top:40px}
  .modal[aria-hidden="false"]{display:block}
  .modal-content{background:#fff;margin:20px auto;padding:16px;border-radius:8px;max-width:720px;position:relative;outline:0;box-shadow:var(--card-shadow)}
  .close{position:absolute;right:12px;top:8px;font-size:22px;cursor:pointer;color:#666;background:transparent;border:none}
  .close:focus{outline:3px solid rgba(0,0,0,.12);outline-offset:2px}
  .field{margin:8px 0}
  .field label{display:block;margin-bottom:6px;font-weight:600}
  input[type="date"], input[type="number"], select, input[type="text"], input[type="password"]{padding:8px;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
  .option-container{display:flex;flex-wrap:wrap;gap:6px}
  .option-btn{padding:8px 10px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
  .option-btn.selected{background:#128c5e}
  .list-item{padding:8px;background:#fafafa;border-radius:6px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
  .del-btn{background:#d9534f;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  .small{font-size:13px;color:#333}
  .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .legend-item{display:flex;gap:6px;align-items:center;padding:6px 8px;background:#fff;border-radius:6px;border:1px solid #eee}
  .swatch{width:16px;height:16px;border-radius:4px;display:inline-block}
  .tooltip{position:fixed;pointer-events:none;background:#111;color:#fff;padding:8px;border-radius:6px;font-size:13px;z-index:9999;opacity:0;transform:translateY(-6px);transition:opacity .12s,transform .12s;max-width:300px;box-shadow:0 6px 20px rgba(0,0,0,.2)}
  .tooltip.show{opacity:1;transform:translateY(0)}
  .tooltip b{display:block;margin-bottom:4px}
  .horario-indicador{display:inline-block;font-size:10px;padding:2px 6px;margin:4px 4px 0 0;border-radius:999px;text-align:center;color:#fff;opacity:0.95}
  .ind-chrom{background:var(--chromebooks)}
  .ind-coz{background:var(--cozinha)}
  .ind-tele{background:var(--telesala)}
  .ind-att{background:var(--salaatendimento)}
  .ind-reun{background:var(--salareunioes)}
  .ind-carro{background:var(--carro)}
  .ind-lq{background:var(--labquimica)}
  .ind-lf{background:var(--labfisica)}
  .ind-lb{background:var(--labiologia)}
  .ind-ctc{background:var(--salactc)}
  .ind-bloq{background:var(--bloqueio)}
  .muted{color:var(--muted);font-size:13px}
  [tabindex]:focus, button:focus, a:focus, input:focus, select:focus { outline:3px solid rgba(7,94,84,.14); outline-offset:2px }

  /* login bar */
  #loginBar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  #loginBar input{padding:8px;border-radius:6px;border:1px solid #ccc}
  #loginBar button{padding:8px 10px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}

  /* hide calendar until logged in */
  .hidden { display:none !important; }

  @media (max-width:900px){
    th,td{font-size:12px;min-width:90px;min-height:100px}
    .legend{font-size:13px}
    .badge{font-size:12px}
  }
  /* ====== RESUMO CHROMEBOOKS MELHORADO ====== */
.resumo-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.resumo-card{
  background:rgba(255,255,255,0.15);
  padding:6px 8px;
  border-radius:8px;

  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 1px 3px rgba(0,0,0,0.15);

  font-size:11px;
  line-height:1.3;
}

.resumo-card.full{
  background:#b00020;
}

.resumo-horario{
  font-weight:700;
  font-size:11px;
  margin-bottom:2px;
}

.resumo-bar{
  height:5px;
  background:rgba(255,255,255,0.25);
  border-radius:4px;
  overflow:hidden;
  margin:3px 0;
}

.resumo-bar-fill{
  height:100%;
  background:#fff;
  width:0%;
  transition:width .3s ease;
}

.resumo-card.full .resumo-bar-fill{
  background:#ffeb3b;
}

.resumo-numeros{
  display:flex;
  justify-content:space-between;
  font-size:13px;   /* aumenta tamanho */
  font-weight:700;  /* negrito */
  color:#fff;       /* branco */
  gap:6px;
}
</style>
</head>
<body>
<div class="container">
  <h2>Calend√°rio de Reservas ‚Äî Col√©gio Imperatriz</h2>

  <!-- LOGIN BAR (topo) -->
  <div id="loginBar" aria-live="polite">
    <input id="loginCpf" placeholder="CPF do admin" aria-label="CPF do admin" />
    <input id="loginSenha" placeholder="Senha" type="password" aria-label="Senha do admin" />
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;background:#d9534f;margin-left:8px">Logout</button>
    <div id="loginMsg" class="muted" style="margin-left:12px"></div>
  </div>

  <div id="topBar">
    <div class="controls" aria-hidden="false">
      <button id="refreshBtn" class="btn primary" title="Atualizar calend√°rio" aria-label="Atualizar calend√°rio">üîÅ Atualizar</button>
      <button id="openManualBtn" class="btn warn" title="Abrir libera√ß√£o manual" aria-label="Abrir libera√ß√£o manual">üóùÔ∏è Liberar Manualmente</button>
      <select id="filterAmbiente" aria-label="Filtrar por ambiente" class="btn ghost" style="margin-left:8px;padding:6px 10px;border-radius:8px">
        <option value="all">Mostrar todos ambientes</option>
        <option>Chromebooks</option>
        <option>Cozinha</option>
        <option>Tele Sala</option>
        <option>Sala de Atendimento I</option>
        <option>Sala de Reuni√µes</option>
        <option>Carro</option>
        <option>Lab. Qu√≠mica</option>
        <option>Lab. F√≠sica</option>
        <option>Lab. Biologia</option>
        <option>Sala do CTC</option>
      </select>
    </div>
<div id="totalsBar" style="text-align:right">
 <div class="badge" aria-live="polite">
  <div id="detalhesPorHorario"></div>
</div>
</div>

  <div class="legend" id="legend" aria-hidden="false">
    <div class="legend-item"><span class="swatch" style="background:var(--chromebooks)"></span> Chromebooks</div>
    <div class="legend-item"><span class="swatch" style="background:var(--cozinha)"></span> Cozinha</div>
    <div class="legend-item"><span class="swatch" style="background:var(--telesala)"></span> Tele Sala</div>
    <div class="legend-item"><span class="swatch" style="background:var(--salaatendimento)"></span> Sala de Atendimento I</div>
    <div class="legend-item"><span class="swatch" style="background:var(--salareunioes)"></span> Sala de Reuni√µes</div>
    <div class="legend-item"><span class="swatch" style="background:var(--carro)"></span> Carro</div>
    <div class="legend-item"><span class="swatch" style="background:var(--labquimica)"></span> Lab. Qu√≠mica</div>
    <div class="legend-item"><span class="swatch" style="background:var(--labfisica)"></span> Lab. F√≠sica</div>
    <div class="legend-item"><span class="swatch" style="background:var(--labiologia)"></span> Lab. Biologia</div>
    <div class="legend-item"><span class="swatch" style="background:var(--salactc)"></span> Sala do CTC</div>
    <div class="legend-item"><span class="swatch" style="background:var(--bloqueio)"></span> Bloqueio</div>
  </div>

  <div style="height:12px"></div>

  <div id="calendarWrap" class="calendar" role="region" aria-label="Calend√°rio de Reservas">
    <div style="padding:8px 12px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px">
      <div id="calendarHeader" style="flex:1"></div>
      <div class="muted" id="loadStatus" aria-live="polite" style="font-size:13px"></div>
    </div>

    <div class="scroll-container" style="padding:8px">
      <table aria-hidden="false">
        <thead>
          <tr id="theadRow"><th scope="col">Dom</th><th scope="col">Seg</th><th scope="col">Ter</th><th scope="col">Qua</th><th scope="col">Qui</th><th scope="col">Sex</th><th scope="col">S√°b</th></tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>
  </div>

  <!-- modal detalhes -->
  <div id="reservationModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="resTitle" tabindex="-1">
    <div class="modal-content" role="document">
      <button id="closeModal" class="close" aria-label="Fechar">&times;</button>
      <h3 id="resTitle">Detalhes da Reserva</h3>
      <p><strong>Ambiente:</strong> <span id="modalAmbiente"></span></p>
      <p><strong>Professor:</strong> <span id="modalProfessor"></span></p>
      <p><strong>Data:</strong> <span id="modalData"></span></p>
      <p><strong>Hor√°rios:</strong> <span id="modalHorarios"></span></p>
      <p><strong>Quantidade:</strong> <span id="modalQuantidade"></span></p>
      <p><strong>Observa√ß√£o:</strong> <span id="modalObs"></span></p>
      <div id="modalPerHorario" style="margin-top:8px"></div>
      <div style="margin-top:12px;">
        <button id="cancelReservationBtn" class="btn primary">Cancelar Reserva</button>
      </div>
    </div>
  </div>

  <!-- modal liberar manual -->
  <div id="manualReleaseModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="manualTitle" tabindex="-1">
    <div class="modal-content" role="document">
      <button id="closeManual" class="close" aria-label="Fechar">&times;</button>
      <h3 id="manualTitle">Libera√ß√£o Manual de Recursos</h3>

      <div class="field">
        <label for="manualAmbiente">Ambiente</label>
        <select id="manualAmbiente">
          <option>Chromebooks</option>
          <option>Cozinha</option>
          <option>Tele Sala</option>
          <option>Sala de Atendimento I</option>
          <option>Sala de Reuni√µes</option>
          <option>Carro</option>
          <option>Lab. Qu√≠mica</option>
          <option>Lab. F√≠sica</option>
          <option>Lab. Biologia</option>
          <option>Sala do CTC</option>
        </select>
      </div>

      <div class="field">
        <label for="manualDate">Data</label>
        <input type="date" id="manualDate" />
      </div>

      <div class="field">
        <label>Hor√°rios (selecione um ou mais)</label>
        <div id="manualHorarios" class="option-container" aria-label="Hor√°rios"></div>
      </div>

      <div class="field">
        <label for="manualQuantidade">Quantidade (por hor√°rio)</label>
        <input type="number" id="manualQuantidade" min="1" value="1" />
      </div>

      <div class="field">
        <label for="manualObs">Observa√ß√£o (opcional)</label>
        <input type="text" id="manualObs" placeholder="Ex.: Libera√ß√£o para professor Fulano" />
      </div>

      <div style="margin-top:8px;">
        <button id="confirmManual" class="btn primary">Confirmar libera√ß√£o</button>
      </div>

      <hr style="margin:12px 0" />
      <h4>Bloqueios existentes</h4>
      <div id="bloqueiosList" class="small" aria-live="polite"></div>
    </div>
  </div>
</div>

<div id="tooltip" class="tooltip" aria-hidden="true"></div>

<script>
/* ============================================================
   v3.0 - Painel com login de administrador (client-side, valida via tabela administrators)
   Mantive URL e API KEY originais.
   ============================================================ */

/* =============== CONFIGURA√á√ÉO SUPABASE =============== */
const SUPABASE_URL = "https://oufiieqxyyqnqpcbuyms.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91ZmlpZXF4eXlxbnFwY2J1eW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDMwNDgsImV4cCI6MjA3NDkxOTA0OH0.-4QPA1R5y24daAt-WsZuWc8-2bJxCJGhdTR1nq4RnHc";
const headers = { "Content-Type":"application/json", "apikey":SUPABASE_KEY, "Authorization":`Bearer ${SUPABASE_KEY}` };
/* ==================================================== */

const MAX_CHROMEBOOKS = 85;
const MAX_DEFAULT = 1;
const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];

let reservas = [], bloqueios = [];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let isLoggedIn = false;
let loggedAdmin = null;

/* ----------------- helpers ----------------- */
function hojeStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function isoToBR(iso){ if(!iso) return '---'; const part=(iso||'').split('T')[0]; return part.split('-').reverse().join('/'); }
function toArray(val){ if(!val) return []; if(Array.isArray(val)) return val; try{ return JSON.parse(val); }catch(e){ if(typeof val==='string') return val.split(',').map(s=>s.trim()).filter(Boolean); return []; } }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ----------------- UI helpers ----------------- */
const tooltip = document.getElementById('tooltip');
function showTooltip(e){
  const el = e.currentTarget;
  const prof = el.dataset.prof || '---';
  const quant = el.dataset.quant || '-';
  const horariosText = el.dataset.horarios || '';
  const data = el.dataset.data || '';
  const ambiente = el.dataset.ambiente || '';
  const obs = el.dataset.obs || '';
  tooltip.innerHTML = `<b>${ambiente}</b><div>${prof} ‚Äî ${quant} unidade(s)</div><div style="font-size:12px;margin-top:4px">${horariosText} ‚Ä¢ ${isoToBR(data)}</div>${obs ? `<div style="margin-top:6px;font-size:12px"><i>${obs}</i></div>` : ''}`;
  tooltip.classList.add('show');
  moveTooltip(e);
  tooltip.setAttribute('aria-hidden','false');
}
function moveTooltip(e){
  const pad = 12;
  let x = e.clientX + pad;
  let y = e.clientY + pad;
  const rect = tooltip.getBoundingClientRect();
  if (x + rect.width > window.innerWidth) x = e.clientX - rect.width - pad;
  if (y + rect.height > window.innerHeight) y = e.clientY - rect.height - pad;
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}
function hideTooltip(){
  tooltip.classList.remove('show');
  tooltip.setAttribute('aria-hidden','true');
}

/* ----------------- chamadas Supabase (robustas) ----------------- */
async function fetchJson(url){
  try{
    const r = await fetch(url,{headers});
    if(!r.ok){ console.error('fetchJson',url,r.status); return []; }
    const json = await r.json();
    return json;
  }catch(e){ console.error('fetchJson err',e); return []; }
}
async function fetchReservas(){ return await fetchJson(`${SUPABASE_URL}/rest/v1/reservas?select=*`); }
async function fetchBloqueios(){ return await fetchJson(`${SUPABASE_URL}/rest/v1/bloqueios?select=*`); }
async function fetchAdministrators(){ return await fetchJson(`${SUPABASE_URL}/rest/v1/administrators?select=*`); }

async function criarReserva(body){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/reservas`,{method:'POST',headers,body:JSON.stringify(body)});
    if(!res.ok){ const txt = await res.text(); throw new Error(txt||res.status); }
    const text = await res.text();
    try{ return JSON.parse(text); }catch(e){ return text || {}; }
  }catch(e){ console.error('criarReserva',e); throw e; }
}

async function criarBloqueio(body){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/bloqueios`,{method:'POST',headers,body:JSON.stringify(body)});
    if(!res.ok){ const txt = await res.text(); throw new Error(txt||res.status); }
    const text = await res.text();
    try{ return JSON.parse(text); }catch(e){ return text || {}; }
  }catch(e){ console.error('criarBloqueio',e); throw e; }
}

async function deleteReserva(id){
  try{ await fetch(`${SUPABASE_URL}/rest/v1/reservas?id=eq.${id}`,{method:'DELETE',headers}); }catch(e){ console.error('deleteReserva',e); }
}

/* ----------------- mapa por data-hor√°rio-ambiente ----------------- */
function buildReservasPorDataHorarioPara(dataISO){
  const mapa = {};
  reservas.filter(r=>{ const d=r.datafim||r.dataFim||''; return d && d.startsWith(dataISO); })
    .forEach(r=>{
      const amb = (r.ambiente || 'Chromebooks');
      const arr = toArray(r.horarios);
      arr.forEach(h=>{
        const key = `${amb}-${h}`;
        mapa[key] = (mapa[key]||0) + (Number(r.quantidade)||0);
      });
    });
  bloqueios.filter(b=>{ const d=b.datafim||b.dataFim||''; return d && d.startsWith(dataISO); })
    .forEach(b=>{
      const amb = (b.ambiente || 'Chromebooks');
      const arr = toArray(b.horarios);
      arr.forEach(h=>{
        const key = `${amb}-${h}`;
        mapa[key] = (mapa[key]||0) + (Number(b.quantidade)||0);
      });
    });
  return mapa;
}

/* ----------------- montar calend√°rio ----------------- */
async function montarCalendario(ano=currentYear, mes=currentMonth){
  currentYear = ano; currentMonth = mes;
  setLoading(true,'Carregando calend√°rio...');
  try{
    reservas = await fetchReservas();
    bloqueios = await fetchBloqueios();
  }catch(e){
    console.error('Erro ao buscar dados',e);
  }

  const tbody = document.getElementById('calendarBody'); tbody.innerHTML='';
  const primeiroDia = new Date(ano,mes,1);
  const ultimoDia = new Date(ano,mes+1,0);
  const diasNoMes = ultimoDia.getDate();

  const mesesDisponiveis = new Set([...reservas,...bloqueios].map(r=>{
    const d = r.datafim || r.dataFim || '';
    if(!d) return null;
    const p = d.split('-');
    return p.length>=2 ? `${p[0]}-${p[1].padStart(2,'0')}` : null;
  }).filter(Boolean));
  mesesDisponiveis.add(`${ano}-${String(mes+1).padStart(2,'0')}`);
  const header = document.getElementById('calendarHeader'); header.innerHTML='';
  const select = document.createElement('select');
  Array.from(mesesDisponiveis).sort((a,b)=>{ const [ay,am]=a.split('-').map(Number); const [by,bm]=b.split('-').map(Number); return ay-by || am-bm; }).forEach(val=>{
    const [y,m] = val.split('-'); const option = document.createElement('option'); option.value = val;
    option.textContent = `${new Date(Number(y),Number(m)-1).toLocaleString('pt-BR',{month:'long'})} ${y}`;
    if(Number(y)===ano && Number(m)-1===mes) option.selected=true;
    select.appendChild(option);
  });
  select.onchange = function(){ const [y,m] = this.value.split('-').map(Number); montarCalendario(y,m-1); };
  header.appendChild(select);

  const filterAmb = document.getElementById('filterAmbiente');
  const filtro = filterAmb.value || 'all';

  let tr = document.createElement('tr');
  for(let i=0;i<primeiroDia.getDay();i++) tr.appendChild(document.createElement('td'));

  for(let dia=1; dia<=diasNoMes; dia++){
    if(tr.children.length===7){ tbody.appendChild(tr); tr = document.createElement('tr'); }
    const td = document.createElement('td');
    const dataStr = `${ano}-${String(mes+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
    const divDia = document.createElement('div'); divDia.style.fontWeight='bold'; divDia.textContent = dia; td.appendChild(divDia);

    const mapaHorario = buildReservasPorDataHorarioPara(dataStr);

    horarios.forEach(h=>{
      const ambientes = ['Chromebooks','Cozinha','Tele Sala','Sala de Atendimento I','Sala de Reuni√µes','Carro','Lab. Qu√≠mica','Lab. F√≠sica','Lab. Biologia','Sala do CTC'];
      ambientes.forEach(amb => {
        if(filtro !== 'all' && filtro !== amb) return;
        const key = `${amb}-${h}`;
        const ocupados = mapaHorario[key]||0;
        if(ocupados > 0){
          const span = document.createElement('span');
          span.classList.add('horario-indicador');
          if(amb==='Chromebooks') span.classList.add('ind-chrom');
          else if(amb==='Cozinha') span.classList.add('ind-coz');
          else if(amb==='Tele Sala') span.classList.add('ind-tele');
          else if(amb==='Sala de Atendimento I') span.classList.add('ind-att');
          else if(amb==='Sala de Reuni√µes') span.classList.add('ind-reun');
          else if(amb==='Carro') span.classList.add('ind-carro');
          else if(amb==='Lab. Qu√≠mica') span.classList.add('ind-lq');
          else if(amb==='Lab. F√≠sica') span.classList.add('ind-lf');
          else if(amb==='Lab. Biologia') span.classList.add('ind-lb');
          else if(amb==='Sala do CTC') span.classList.add('ind-ctc');
          span.title = `${amb} ‚Äî ${h}: ${ocupados}`;
          span.textContent = `${h} (${ocupados})`;
          td.appendChild(span);
        }
      });
    });

    reservas.filter(r=>{ const d=r.datafim||r.dataFim||''; return d && d.startsWith(dataStr); })
      .forEach(r=>{
        const arr = toArray(r.horarios);
        arr.forEach(h=>{
          const amb = (r.ambiente||'Chromebooks');
          if(filterAmb.value !== 'all' && filterAmb.value !== amb) return;
          const div = document.createElement('div'); div.classList.add('reserva');
          // normalizar classe
          const cls = 'amb-' + amb.replace(/\s+/g,'').replace(/[^a-zA-Z0-9]/g,'');
          div.classList.add(cls);
          const prof = r.professor || '---';
          div.innerText = amb==='Chromebooks' ? `${h} ${prof} (${r.quantidade||1})` : `${h} ${amb} ‚Äî ${prof}`;
          div.dataset.prof = prof;
          div.dataset.quant = r.quantidade || 1;
          div.dataset.horarios = h;
          div.dataset.data = dataStr;
          div.dataset.ambiente = amb;
          div.dataset.resId = r.id || '';
          div.dataset.obs = r.observacao || r.obs || '';
          div.addEventListener('mouseenter', showTooltip);
          div.addEventListener('mousemove', moveTooltip);
          div.addEventListener('mouseleave', hideTooltip);
          div.onclick = ()=> openModal(r);
          td.appendChild(div);
        });
      });

    bloqueios.filter(b=>{ const d=b.datafim||b.dataFim||''; return d && d.startsWith(dataStr); })
      .forEach(b=>{
        const arr = toArray(b.horarios);
        arr.forEach(h=>{
          if(filterAmb.value !== 'all' && filterAmb.value !== (b.ambiente||'Chromebooks')) return;
          const div = document.createElement('div'); div.classList.add('reserva','bloqueio');
          div.innerText = `${h} BLOQUEIO (${b.quantidade})`;
          div.dataset.prof = 'Sistema (bloqueio)';
          div.dataset.quant = b.quantidade || 0;
          div.dataset.horarios = h;
          div.dataset.data = dataStr;
          div.dataset.ambiente = b.ambiente || 'Chromebooks';
          div.dataset.obs = b.observacao || b.obs || '';
          div.addEventListener('mouseenter', showTooltip);
          div.addEventListener('mousemove', moveTooltip);
          div.addEventListener('mouseleave', hideTooltip);
          td.appendChild(div);
        });
      });

    tr.appendChild(td);
  }

  while(tr.children.length<7) tr.appendChild(document.createElement('td'));
  tbody.appendChild(tr);

  atualizarTotaisDia();
  setLoading(false);
}

/* ----------------- totais por hoje ----------------- */
function atualizarTotaisDia(){
  const hoje = hojeStr();
  const mapa = buildReservasPorDataHorarioPara(hoje);
  const dataBR = hoje.split('-').reverse().join('/');

  const horariosManha = ['07:20','08:05','08:50','09:55','10:40','11:25'];
  const horariosTarde = ['13:45','14:30','15:35','16:20','17:05'];

  let html = `
    <div style="font-weight:600;font-size:15px;margin-bottom:8px;text-align:center;color:#fff;border-bottom:1px solid rgba(255,255,255,.3);padding-bottom:4px;">
      Reservas de hoje (${dataBR}) / hor√°rio
    </div>

    <div class="resumo-grid">
      <div>
  `;

  // üîπ COLUNA ESQUERDA - MANH√É
  horariosManha.forEach(h=>{
    html += gerarCardResumo(h, mapa);
  });

  html += `</div><div>`;

  // üîπ COLUNA DIREITA - TARDE
  horariosTarde.forEach(h=>{
    html += gerarCardResumo(h, mapa);
  });

  html += `</div></div>`;

  document.getElementById('detalhesPorHorario').innerHTML = html;
}
function gerarCardResumo(h, mapa){
  const reservados = mapa[`Chromebooks-${h}`] || 0;
  const disponiveis = Math.max(0, MAX_CHROMEBOOKS - reservados);
  const porcentagem = Math.min(100, (reservados / MAX_CHROMEBOOKS) * 100);
  const fullClass = reservados >= MAX_CHROMEBOOKS ? 'full' : '';

  return `
    <div class="resumo-card ${fullClass}">
      <div class="resumo-horario">${h}</div>
      <div class="resumo-bar">
        <div class="resumo-bar-fill" style="width:${porcentagem}%"></div>
      </div>
      <div class="resumo-numeros">
        <span>Reservados: ${reservados}</span>
        <span>Dispon√≠veis: ${disponiveis}</span>
      </div>
    </div>
  `;
}
/* ----------------- modal detalhes (cancelar exige login) ----------------- */
function openModal(r){
  const ambiente = r.ambiente || 'Chromebooks';
  document.getElementById('modalAmbiente').textContent = ambiente;
  document.getElementById('modalProfessor').textContent = r.professor || '---';
  document.getElementById('modalData').textContent = isoToBR(r.datafim || r.dataFim);
  document.getElementById('modalHorarios').textContent = toArray(r.horarios).join(', ');
  document.getElementById('modalQuantidade').textContent = r.quantidade || 1;
  document.getElementById('modalObs').textContent = r.observacao || r.obs || '---';

  const perHorarioDiv = document.getElementById('modalPerHorario'); perHorarioDiv.innerHTML='';
  const counts = buildReservasPorDataHorarioPara(r.datafim || r.dataFim);

  toArray(r.horarios).forEach(h=>{
    const key = `${ambiente}-${h}`;
    const reserved = counts[key] || 0;
    const maxPermitido = (ambiente === 'Chromebooks' ? MAX_CHROMEBOOKS : MAX_DEFAULT);
    const free = Math.max(0, maxPermitido - reserved);
    const p = document.createElement('p'); p.innerHTML = `<strong>${h}:</strong> Reservados: ${reserved} ‚Äî Livres: ${free}`;
    perHorarioDiv.appendChild(p);
  });

  const cancelBtn = document.getElementById('cancelReservationBtn');
  cancelBtn.onclick = async () => {
    if (!isLoggedIn){ alert('A√ß√£o permitida apenas para administradores autenticados.'); return; }
    if (!confirm('Cancelar reserva?')) return;
    setLoading(true, 'Removendo reserva...');

    try {
      await deleteReserva(r.id);
      reservas = await fetchReservas();
      bloqueios = await fetchBloqueios();

      const data = r.datafim || r.dataFim;
      const ambiente = r.ambiente || "Chromebooks";
      const horariosReserva = toArray(r.horarios);

      for (const h of horariosReserva) {
        const ocupadosAgora = reservas
          .filter(rr => (rr.ambiente || 'Chromebooks') === ambiente && (rr.datafim||rr.dataFim) === data && (toArray(rr.horarios)||[]).includes(h))
          .reduce((s, rr) => s + (Number(rr.quantidade) || 0), 0);

        const maxPermitido = (ambiente === 'Chromebooks' ? MAX_CHROMEBOOKS : MAX_DEFAULT);

        if (ocupadosAgora < maxPermitido) {
          const bloq = bloqueios.find(b =>
            (b.datafim || b.dataFim) === data &&
            b.ambiente === ambiente &&
            (toArray(b.horarios) || []).includes(h)
          );

          if (bloq) {
            await fetch(`${SUPABASE_URL}/rest/v1/bloqueios?id=eq.${bloq.id}`, {
              method: "DELETE",
              headers
            });
          }
        }
      }

      await montarCalendario();
      closeReservationModal();

    } catch (e) {
      console.error(e);
      alert('Erro ao cancelar. Veja console.');
    }

    setLoading(false);
  };

  const modal = document.getElementById('reservationModal');
  modal.setAttribute('aria-hidden','false');
  modal.style.display='block';
  cancelBtn.focus();
}
function closeReservationModal(){
  const modal = document.getElementById('reservationModal');
  modal.setAttribute('aria-hidden','true');
  modal.style.display='none';
}
document.getElementById('closeModal').onclick = closeReservationModal;

/* ----------------- modal manual (libera√ß√£o) ----------------- */
const openManualBtn = document.getElementById('openManualBtn');
const manualModal = document.getElementById('manualReleaseModal');
const closeManual = document.getElementById('closeManual');
const manualHorarios = document.getElementById('manualHorarios');
const manualDate = document.getElementById('manualDate');
const manualQuantidade = document.getElementById('manualQuantidade');
const confirmManual = document.getElementById('confirmManual');
const bloqueiosList = document.getElementById('bloqueiosList');
const manualAmbiente = document.getElementById('manualAmbiente');

openManualBtn.onclick = async ()=>{
  if(!isLoggedIn){ alert('Somente administradores autenticados podem abrir essa tela.'); return; }
  manualHorarios.innerHTML='';
  horarios.forEach(h=>{
    const btn = document.createElement('button');
    btn.classList.add('option-btn');
    btn.type = 'button';
    btn.innerText = h;
    btn.dataset.h = h;
    btn.onclick = ()=> btn.classList.toggle('selected');
    manualHorarios.appendChild(btn);
  });
  manualDate.value = hojeStr();
  manualQuantidade.value = 1;
  await carregarBloqueios();
  manualModal.setAttribute('aria-hidden','false');
  manualModal.style.display='block';
  manualAmbiente.focus();
};
closeManual.onclick = ()=> closeManualModal();
function closeManualModal(){
  manualModal.setAttribute('aria-hidden','true');
  manualModal.style.display='none';
}

/* carregar bloqueios para listagem */
async function carregarBloqueios(){
  bloqueios = await fetchBloqueios();
  bloqueiosList.innerHTML = '';
  if(!bloqueios.length) bloqueiosList.innerHTML = '<div class="muted">Nenhum bloqueio registrado.</div>';
  bloqueios.forEach((b)=>{
    const div = document.createElement('div'); div.classList.add('list-item');
    const arr = toArray(b.horarios);
    div.textContent = `${isoToBR(b.datafim||b.dataFim)} ‚Äî ${arr.join(', ')} ‚Äî Qtde: ${b.quantidade} ‚Äî ${b.ambiente || 'Chromebooks'}`;
    const del = document.createElement('button'); del.textContent='Remover'; del.classList.add('del-btn');
    del.onclick = async ()=>{
      if(!confirm('Remover bloqueio?')) return;
      setLoading(true,'Removendo bloqueio...');
      try{
        await fetch(`${SUPABASE_URL}/rest/v1/bloqueios?id=eq.${b.id}`,{method:'DELETE',headers});
        await montarCalendario();
        await carregarBloqueios();
      }catch(e){ console.error(e); alert('Erro ao remover bloqueio. Veja console.'); }
      setLoading(false);
    };
    div.appendChild(del);
    bloqueiosList.appendChild(div);
  });
}

/* ----------------- libera√ß√£o manual (salvar) ----------------- */
confirmManual.onclick = async ()=>{
  if(!isLoggedIn){ alert('Somente administradores autenticados podem realizar libera√ß√µes.'); return; }
  const selected = Array.from(manualHorarios.querySelectorAll('.selected')).map(b=>b.dataset.h);
  if(selected.length===0){ alert('Selecione ao menos um hor√°rio'); return; }
  const data = manualDate.value; if(!data){ alert('Selecione uma data v√°lida'); return; }
  const obs = (document.getElementById('manualObs') && document.getElementById('manualObs').value) ? document.getElementById('manualObs').value.trim() : '';
  const quantidade = parseInt(manualQuantidade.value) || 1;
  const ambiente = manualAmbiente.value || 'Chromebooks';

  setLoading(true,'Salvando libera√ß√µes...');
  try{
    reservas = await fetchReservas();
    bloqueios = await fetchBloqueios();

    for(const h of selected){
      const ocupados = reservas
        .filter(r => (r.ambiente || 'Chromebooks') === ambiente && (r.datafim||r.dataFim) === data && (toArray(r.horarios)||[]).includes(h))
        .reduce((soma,r)=>soma + (Number(r.quantidade)||0), 0);

      const bloqueado = bloqueios.some(b => (b.datafim||b.dataFim)===data && (toArray(b.horarios)||[]).includes(h) && ((b.ambiente||'Chromebooks')===ambiente));
      if(bloqueado){
        alert(`O hor√°rio ${h} em ${isoToBR(data)} para ${ambiente} j√° est√° bloqueado.`);
        setLoading(false);
        return;
      }

      const maxPermitido = (ambiente==='Chromebooks'?MAX_CHROMEBOOKS:MAX_DEFAULT);
      const totalDepois = ocupados + quantidade;
      if(totalDepois > maxPermitido){
        alert(`N√£o √© poss√≠vel liberar ${quantidade} em ${h} ‚Äî j√° existem ${ocupados} ocupados (m√°x: ${maxPermitido})`);
        setLoading(false);
        return;
      }

      // criar reserva manual (Admin)
      // criar reserva manual usando o admin logado
    await criarReserva({
    professor: loggedAdmin.nome,
    cpf: loggedAdmin.cpf,
    telefone: loggedAdmin.telefone || 'ADMIN',
    email: loggedAdmin.email || 'admin@colegio.com',
    datafim: data,
    horarios: [h],
    ambiente: ambiente,
    quantidade: quantidade,
    observacao: obs || null
    });

      reservas = await fetchReservas();
      const ocupadosAgora = reservas
        .filter(r => (r.ambiente || 'Chromebooks') === ambiente && (r.datafim||r.dataFim) === data && (toArray(r.horarios)||[]).includes(h))
        .reduce((soma,r)=>soma + (Number(r.quantidade)||0), 0);

      if(ocupadosAgora === maxPermitido){
        const existeBloq = (await fetchBloqueios()).some(b => (b.datafim||b.dataFim) === data && (toArray(b.horarios)||[]).includes(h) && ((b.ambiente||'Chromebooks')===ambiente));
        if(!existeBloq){
          await criarBloqueio({ datafim: data, horarios: [h], quantidade: maxPermitido, ambiente: ambiente });
        }
      }
    }

    alert('‚úÖ Libera√ß√µes manuais registradas com sucesso.');
    closeManualModal();
    await montarCalendario();
    await carregarBloqueios();
  }catch(e){
    console.error(e); alert('Erro ao salvar (ver console).');
  }finally{
    setLoading(false);
  }
};

/* ----------------- refresh / controles ----------------- */
document.getElementById('refreshBtn').onclick = ()=> montarCalendario();
document.getElementById('filterAmbiente').onchange = ()=> montarCalendario();

/* ----------------- carregamento / status UI ----------------- */
let loadingCount = 0;
function setLoading(active, message=''){
  const loadStatus = document.getElementById('loadStatus');
  const refreshBtn = document.getElementById('refreshBtn');
  const confirmBtn = document.getElementById('confirmManual');
  if(active){
    loadingCount++;
    loadStatus.textContent = message || 'Carregando...';
    refreshBtn.setAttribute('disabled','true');
    confirmBtn && confirmBtn.setAttribute('disabled','true');
  } else {
    loadingCount = Math.max(0, loadingCount-1);
    if(loadingCount === 0){
      loadStatus.textContent = '';
      refreshBtn.removeAttribute('disabled');
      confirmBtn && confirmBtn.removeAttribute('disabled');
    }
  }
}

/* ----------------- teclado / escape para fechar modais ----------------- */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    closeReservationModal();
    closeManualModal();
  }
});

/* =================== LOGIN/LOGOUT =================== */
/*
  Login simples: busca tabela administrators no Supabase e compara CPF (somente d√≠gitos) e senha em texto.
  Recomendo fortemente migrar para hash/sess√£o real em produ√ß√£o (isto √© apenas autentica√ß√£o client-side baseada em REST).
*/
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginCpf = document.getElementById('loginCpf');
const loginSenha = document.getElementById('loginSenha');
const loginMsg = document.getElementById('loginMsg');
const calendarWrap = document.getElementById('calendarWrap');

function onlyDigits(s){ return (s||'').replace(/\D/g,''); }

loginBtn.onclick = async ()=>{
  const cpfRaw = onlyDigits(loginCpf.value||'');
  const senha = (loginSenha.value||'').trim();
  if(cpfRaw.length !== 11 && !senha){ loginMsg.textContent = 'Informe CPF e senha.'; return; }
  setLoading(true,'Validando administrador...');
  try{
    // buscamos admin por cpf (igual) OU por email se user usar email
    const admins = await fetchAdministrators();
    const found = admins.find(a => ((a.cpf && onlyDigits(a.cpf)===cpfRaw) || (a.email && a.email.toLowerCase() === (loginCpf.value||'').toLowerCase())) && (a.senha === senha));
    if(!found){ loginMsg.textContent = 'Credenciais inv√°lidas'; setLoading(false); return; }
    // sucesso
    isLoggedIn = true; loggedAdmin = found;
    loginMsg.textContent = `Ol√°, ${found.nome}`;
    loginBtn.style.display='none'; logoutBtn.style.display='inline-block';
    loginCpf.style.display='none'; loginSenha.style.display='none';
    // mostrar calend√°rio
    calendarWrap.classList.remove('hidden');
    // habilitar controles de admin
    document.getElementById('openManualBtn').removeAttribute('disabled');
    document.getElementById('refreshBtn').removeAttribute('disabled');
    await montarCalendario();
  }catch(e){
    console.error('login err',e); loginMsg.textContent = 'Erro ao validar (veja console)';
  }finally{ setLoading(false); }
};

logoutBtn.onclick = ()=>{
  isLoggedIn = false; loggedAdmin = null;
  loginBtn.style.display='inline-block'; logoutBtn.style.display='none';
  loginCpf.style.display='inline-block'; loginSenha.style.display='inline-block';
  loginCpf.value=''; loginSenha.value=''; loginMsg.textContent = 'Desconectado';
  // esconder calend√°rio at√© novo login
  calendarWrap.classList.add('hidden');
  // desabilitar controles
  document.getElementById('openManualBtn').setAttribute('disabled','true');
};

/* Ao carregar pela primeira vez, escondemos o calend√°rio at√© o admin logar */
document.getElementById('openManualBtn').setAttribute('disabled','true');
calendarWrap.classList.add('hidden');

/* ----------------- inicializa√ß√£o ----------------- */
async function init(){
  document.getElementById('manualDate').setAttribute('min', hojeStr());
  // n√£o inicia calend√°rio at√© login; podemos pr√©-carregar para performance opcionalmente
  // await montarCalendario();
}
init();
</script>
</body>
</html>
