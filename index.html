<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Reservas - Colégio Imperatriz</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#ece5dd; }
  .chat-container { display:flex; flex-direction:column; max-width:480px; height:100vh; margin:0 auto; border:1px solid #ccc; background:#fff; }
  .messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; background:#e5ddd5; }
  .message { margin:5px 0; padding:10px 14px; border-radius:18px; max-width:75%; word-wrap:break-word; line-height:1.4; white-space:pre-wrap;}
  .from-system { background:#ffffff; align-self:flex-start; }
  .from-user { background:#dcf8c6; align-self:flex-end; }
  .option-btn { background:#25d366; color:#fff; border:none; border-radius:20px; padding:8px 14px; cursor:pointer; margin-top:5px; display:inline-block; user-select:none; transition:background-color 0.3s ease; }
  .option-btn:hover { background-color:#128c5e; }
  .option-container { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
  .input-container { display:flex; padding:10px; background:#f0f0f0; border-top:1px solid #ccc; }
  .input-container input { flex:1; border-radius:25px; border:1px solid #ccc; padding:10px 15px; outline:none; font-size:14px; }
  .input-container input:disabled { background:#e5e5e5; cursor:not-allowed; }
  .input-container button { margin-left:8px; border:none; background:#25d366; color:white; border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; }
  .input-container button:disabled { background:#9fd9a0; cursor:not-allowed; }
  .small-note { font-size:12px; color:#333; margin-top:6px; }
</style>
</head>
<body>

<div class="chat-container">
  <div id="messages" class="messages"></div>
  <div id="inputArea" class="input-container">
    <input id="chatInput" type="text" placeholder="Digite algo para iniciar..." autocomplete="off" />
    <button id="sendBtn">&#9658;</button>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

const SUPABASE_URL = "https://oufiieqxyyqnqpcbuyms.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91ZmlpZXF4eXlxbnFwY2J1eW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDMwNDgsImV4cCI6MjA3NDkxOTA0OH0.-4QPA1R5y24daAt-WsZuWc8-2bJxCJGhdTR1nq4RnHc";
const headers = {
  "Content-Type": "application/json",
  "apikey": SUPABASE_KEY,
  "Authorization": `Bearer ${SUPABASE_KEY}`,
  "Prefer": "return=representation"
};

const MAX_CHROMEBOOKS = 86;
let state = 0;
let professor = {nome:'', cpf:'', telefone:'', email:''};
let reserva = {quantidade: 0, dataFim: '', horarios: [], ambiente: 'Chromebooks'};
let reservasPorDataHorario = {};
let selectedAmbiente = 'Chromebooks';

const AMBIENTES = ['Chromebooks','Cozinha','Tele Sala','Sala de Atendimento I','Sala de Reuniões'];
const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];

async function fetchReservas(){ const r=await fetch(`${SUPABASE_URL}/rest/v1/reservas?select=*`,{headers}); return await r.json(); }
async function fetchProfessores(){ const r=await fetch(`${SUPABASE_URL}/rest/v1/professores?select=*`,{headers}); return await r.json(); }
async function saveProfessor(p){ await fetch(`${SUPABASE_URL}/rest/v1/professores`,{method:"POST",headers,body:JSON.stringify(p)}); }
async function saveReserva(r){ await fetch(`${SUPABASE_URL}/rest/v1/reservas`,{method:"POST",headers,body:JSON.stringify(r)}); }

function addMessage(text, from='system'){ const div=document.createElement('div'); div.classList.add('message', from==='system'?'from-system':'from-user'); div.innerText=text; messagesEl.appendChild(div); messagesEl.scrollTop=messagesEl.scrollHeight; }

function createInput(placeholder, callback){ chatInput.disabled=false; chatInput.value=''; chatInput.placeholder=placeholder; sendBtn.disabled=false; sendBtn.onclick=()=>{ if(chatInput.value.trim()==='') return; const val=chatInput.value.trim(); chatInput.value=''; chatInput.disabled=true; sendBtn.disabled=true; callback(val); }; chatInput.focus(); }

function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
function formatCPF(digits){ return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); }
function brToISO(dateStr){ const [d,m,y]=dateStr.split('/'); return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function isoToBR(iso){ if(!iso) return ''; const p=iso.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }

async function cpfInput(cpfRaw){ const digits=onlyDigits(cpfRaw); if(digits.length!==11){ addMessage('CPF inválido.'); createInput('CPF',cpfInput); return; } const maskedCPF=formatCPF(digits); let professores=await fetchProfessores(); const profExistente=professores.find(p=>onlyDigits(p.cpf||'')===digits); if(profExistente){ professor={...profExistente}; addMessage(`Olá ${professor.nome}!`); showProfessorReservations(digits); askSelectAmbiente(); } else { professor.cpf=maskedCPF; addMessage(maskedCPF,'user'); addMessage('Você não está cadastrado. Nome completo:'); state=11; createInput('Nome', nome=>nextStep(nome)); } }

function nextStep(input){ switch(state){ case 11: professor.nome=input; addMessage(input,'user'); addMessage('Telefone:'); state=12; createInput('Telefone', tel=>{ professor.telefone=tel; addMessage(tel,'user'); addMessage('E-mail:'); state=13; createInput('E-mail', async email=>{ professor.email=email; addMessage(email,'user'); addMessage('Cadastro concluído!'); await saveProfessor(professor); showProfessorReservations(onlyDigits(professor.cpf)); askSelectAmbiente(); }); }); break; } }

async function showProfessorReservations(cpfDigits){ const reservas=await fetchReservas(); const matches=reservas.filter(r=> (r.cpf && onlyDigits(r.cpf)===cpfDigits)||(r.professor===professor.nome)); if(matches.length===0){ addMessage('Você ainda não possui reservas.'); return; } let text='Suas reservas:\n'; matches.forEach(r=>{ text+=`${r.ambiente}: ${r.quantidade||1} em ${isoToBR(r.dataFim)} - ${(r.horarios||[]).join(', ')}\n`; }); addMessage(text); }

function askSelectAmbiente(){ addMessage('Selecione o ambiente:'); const container=document.createElement('div'); container.classList.add('option-container'); AMBIENTES.forEach(a=>{ const btn=document.createElement('button'); btn.classList.add('option-btn'); btn.innerText=a; btn.onclick=()=>{ addMessage(a,'user'); selectedAmbiente=a; reserva={quantidade:0,dataFim:'',horarios:[],ambiente:a}; if(a==='Chromebooks') askDate(); else askDateAmbiente(); }; container.appendChild(btn); }); messagesEl.appendChild(container); messagesEl.scrollTop=messagesEl.scrollHeight; }

function askDate(){ addMessage('Digite a data (dd/mm/yyyy):'); createInput('Data', d=>{ reserva.dataFim=brToISO(d); addMessage(d); if(selectedAmbiente==='Chromebooks') askQuantity(); else askHorariosAmbiente(); }); }
function askDateAmbiente(){ askDate(); }

function askQuantity(){ addMessage('Quantidade de Chromebooks:'); createInput('Quantidade', q=>{ reserva.quantidade=parseInt(q); addMessage(q); askHorarios(); }); }

function askHorarios(){ addMessage('Selecione horários:'); const container=document.createElement('div'); container.classList.add('option-container'); reserva.horariosSelecionados=new Set(); horarios.forEach(h=>{ const btn=document.createElement('button'); btn.classList.add('option-btn'); btn.innerText=h; btn.onclick=()=>{ if(reserva.horariosSelecionados.has(h)){reserva.horariosSelecionados.delete(h); btn.style.backgroundColor='#25d366';} else{reserva.horariosSelecionados.add(h); btn.style.backgroundColor='#128c5e';} }; container.appendChild(btn); }); const confirm=document.createElement('button'); confirm.classList.add('option-btn'); confirm.innerText='Confirmar'; confirm.style.backgroundColor='#075E54'; confirm.onclick=()=>{ reserva.horarios=Array.from(reserva.horariosSelecionados); confirmReservation(); }; container.appendChild(confirm); messagesEl.appendChild(container); }

function askHorariosAmbiente(){ askHorarios(); }

async function confirmReservation(){ reserva.professor=professor.nome; reserva.cpf=professor.cpf; reserva.telefone=professor.telefone; reserva.ambiente=selectedAmbiente; if(reserva.quantidade===0) reserva.quantidade=1; await saveReserva(reserva); addMessage('Reserva confirmada!'); askSelectAmbiente(); }

addMessage('Olá, eu sou a Leopoldina. Digite seu CPF para começar:');
state=0; createInput('CPF',cpfInput); chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!sendBtn.disabled){ sendBtn.click(); e.preventDefault(); }});
</script>
</body>
</html>
