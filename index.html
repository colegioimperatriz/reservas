<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>v1.4 - Sistema de Reservas - Colégio Imperatriz</title>
<style>
  :root{ --bg:#ece5dd; --card:#fff; --muted:#e5ddd5; --accent:#25d366; --accent-dark:#128c5e; --accent-darker:#075E54; --text:#222; --radius:18px; }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
  /* Layout */
  .chat-container{display:flex;flex-direction:column;max-width:820px;height:100vh;margin:0 auto;border:1px solid #ccc;background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,0.06);border-radius:10px;overflow:hidden}
  /* Messages area */
  .messages{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:8px;background:var(--muted);}
  .message{margin:0; padding:12px 14px;border-radius:var(--radius);max-width:78%;word-wrap:break-word;line-height:1.45;white-space:pre-wrap}
  .from-system{background:var(--card);align-self:flex-start}
  .from-user{background:#dcf8c6;align-self:flex-end}
  /* Options */
  .option-btn{background:var(--accent);color:#fff;border:0;border-radius:20px;padding:8px 14px;cursor:pointer;margin-top:5px;display:inline-block;user-select:none;transition:background-color .18s ease,transform .08s}
  .option-btn:hover{background:var(--accent-dark);transform:translateY(-1px)}
  .option-btn.disabled{background:#ccc!important;cursor:not-allowed}
  .option-container{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  /* Input area sticky to bottom and safe-area aware */
  .input-container{display:flex;padding:12px;gap:8px;background:#f7f7f7;border-top:1px solid #ddd;position:sticky;bottom:env(safe-area-inset-bottom,0);align-items:center}
  .input-container input{flex:1;border-radius:28px;border:1px solid #ccc;padding:10px 14px;outline:0;font-size:1rem}
  .input-container input:disabled{background:#eee;cursor:not-allowed}
  .input-container button{border:0;background:var(--accent);color:#fff;border-radius:50%;width:44px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
  .input-container button:disabled{background:#9fd9a0;cursor:not-allowed}
  /* Small screens tweaks */
  @media (max-width:520px){
    .chat-container{max-width:100%;border-radius:0}
    .message{max-width:86%;font-size:0.97rem}
    .input-container{padding:10px}
    .option-btn{padding:7px 12px;font-size:0.95rem}
  }
  /* Large screens */
  @media (min-width:900px){
    .chat-container{max-width:720px}
    .messages{padding:22px}
  }
</style>
</head>
<body>

<div class="chat-container">
  <div id="messages" class="messages"></div>
  <div id="inputArea" class="input-container">
    <input id="chatInput" type="text" placeholder="Digite algo para iniciar..." autocomplete="off" />
    <button id="sendBtn">&#9658;</button>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

const SUPABASE_URL = "https://oufiieqxyyqnqpcbuyms.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91ZmlpZXF4eXlxbnFwY2J1eW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDMwNDgsImV4cCI6MjA3NDkxOTA0OH0.-4QPA1R5y24daAt-WsZuWc8-2bJxCJGhdTR1nq4RnHc";
const headers = {
  "Content-Type": "application/json",
  "apikey": SUPABASE_KEY,
  "Authorization": `Bearer \${SUPABASE_KEY}`,
  "Prefer": "return=representation"
};

const MAX_CHROMEBOOKS = 85;
const MAX_DEFAULT = 1; // demais ambientes

let state = 0;
let professor = {nome:'', cpf:'', telefone:'', email:''};
let reserva = {quantidade: 0, dataFim: '', horarios: [], ambiente: 'Chromebooks'};
let selectedAmbiente = 'Chromebooks';

const AMBIENTES = ['Chromebooks','Cozinha','Tele Sala','Sala de Atendimento I','Sala de Reuniões'];
const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];

async function fetchReservas(){ const r=await fetch(`\${SUPABASE_URL}/rest/v1/reservas?select=*`,{headers}); return await r.json(); }
async function fetchProfessores(){ const r=await fetch(`\${SUPABASE_URL}/rest/v1/professores?select=*`,{headers}); return await r.json(); }
async function saveProfessor(p){ await fetch(`\${SUPABASE_URL}/rest/v1/professores`,{method:"POST",headers,body:JSON.stringify(p)}); }

async function saveReserva(r){
  const res = await fetch(`\${SUPABASE_URL}/rest/v1/reservas`, {
    method:"POST", headers,
    body: JSON.stringify({
      professor: r.professor,
      cpf: r.cpf,
      telefone: r.telefone,
      email: r.email,
      datafim: r.dataFim,
      horarios: r.horarios,
      ambiente: r.ambiente,
      quantidade: r.quantidade
    })
  });
  return await res.json();
}

async function saveBloqueio(r){
  const bloqueiosExist = await fetch(`\${SUPABASE_URL}/rest/v1/bloqueios?select=*&datafim=eq.\${r.dataFim}`, {headers});
  const existentes = await bloqueiosExist.json();

  const jaExiste = existentes.some(b => 
    b.datafim === r.dataFim && (b.horarios||[]).some(h => r.horarios.includes(h))
  );

  if(jaExiste) return;

  const res = await fetch(`\${SUPABASE_URL}/rest/v1/bloqueios`, {
    method:"POST", headers,
    body: JSON.stringify({
      datafim: r.dataFim,
      horarios: r.horarios,
      quantidade: r.quantidade
    })
  });
  return await res.json();
}

function addMessage(text, from='system'){ 
  const div=document.createElement('div'); 
  div.classList.add('message', from==='system'?'from-system':'from-user'); 
  div.innerText=text; 
  messagesEl.appendChild(div); 
  messagesEl.scrollTop=messagesEl.scrollHeight; 
}

function createInput(placeholder, callback){ 
  chatInput.disabled=false; chatInput.value=''; chatInput.placeholder=placeholder; 
  sendBtn.disabled=false; 
  sendBtn.onclick=()=>{ 
    if(chatInput.value.trim()==='') return; 
    const val=chatInput.value.trim(); 
    chatInput.value=''; 
    chatInput.disabled=true; 
    sendBtn.disabled=true; 
    callback(val); 
  }; 
  chatInput.focus(); 
}

function onlyDigits(s){ return (s||'').replace(/\\D/g,''); }
function formatCPF(digits){ return digits.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{2})/,'$1.$2.$3-$4'); }
function brToISO(dateStr){ const [d,m,y]=dateStr.split('/'); return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function isoToBR(iso){ if(!iso) return ''; return iso.split('T')[0].split('-').reverse().join('/'); }

async function cpfInput(cpfRaw){ 
  const digits=onlyDigits(cpfRaw); 
  if(digits.length!==11){ addMessage('CPF inválido.'); createInput('CPF',cpfInput); return; } 
  const maskedCPF=formatCPF(digits); 
  let professores=await fetchProfessores(); 
  const profExistente=professores.find(p=>onlyDigits(p.cpf||'')===digits); 
  if(profExistente){ 
    professor={...profExistente}; 
    addMessage(`Olá ${professor.nome}!`); 
    await showProfessorReservations(digits); 
    askSelectAmbiente(); 
  } else { 
    professor.cpf=maskedCPF; 
    addMessage(maskedCPF,'user'); 
    addMessage('Digite seu nome completo:'); 
    state=11; 
    createInput('Nome completo', nome=>nextStep(nome)); 
  } 
}

function nextStep(input){ 
  switch(state){ 
    case 11: 
      professor.nome=input; 
      addMessage(input,'user'); 
      addMessage('Telefone:'); 
      state=12; 
      createInput('Telefone', tel=>{ 
        professor.telefone=tel; 
        addMessage(tel,'user'); 
        addMessage('E-mail:'); 
        state=13; 
        createInput('E-mail', async email=>{ 
          professor.email=email; 
          addMessage(email,'user'); 
          addMessage('Cadastro concluído!'); 
          await saveProfessor(professor); 
          await showProfessorReservations(onlyDigits(professor.cpf)); 
          askSelectAmbiente(); 
        }); 
      }); 
      break; 
  } 
}

async function showProfessorReservations(cpfDigits){ 
  const reservas = await fetchReservas();

  // Data atual (local do dispositivo)
  const hoje = new Date();
  hoje.setHours(0,0,0,0);

  const matches = reservas.filter(r => {
    const ok = (r.cpf && onlyDigits(r.cpf) === cpfDigits) || (r.professor === professor.nome);
    if (!ok) return false;

    const dataR = new Date(r.datafim);
    dataR.setHours(0,0,0,0);
    return dataR >= hoje; // SOMENTE HOJE EM DIANTE
  });

  if (matches.length === 0){ 
    addMessage('Você ainda não possui reservas futuras.'); 
    return; 
  } 

  let text = 'Suas reservas (apenas futuras):\\n'; 
  matches.forEach(r => { 
    text += `${r.ambiente}: ${r.quantidade||1} em ${isoToBR(r.datafim)} - ${(r.horarios||[]).join(', ')}\\n`; 
  }); 

  addMessage(text); 
}

function askSelectAmbiente(){ 
  addMessage('Selecione o ambiente:'); 
  const container=document.createElement('div'); 
  container.classList.add('option-container'); 
  AMBIENTES.forEach(a=>{ 
    const btn=document.createElement('button'); 
    btn.classList.add('option-btn'); 
    btn.innerText=a; 
    btn.onclick=()=>{ 
      addMessage(a,'user'); 
      selectedAmbiente=a; 
      reserva={quantidade:0,dataFim:'',horarios:[],ambiente:a}; 
      if(a==='Chromebooks') askDate(); else askDateAmbiente(); 
    }; 
    container.appendChild(btn); 
  }); 
  messagesEl.appendChild(container); 
  messagesEl.scrollTop=messagesEl.scrollHeight; 
}

function askDate(){ 
  addMessage('Digite a data (dd/mm/yyyy):'); 
  createInput('Data', d=>{ 
    reserva.dataFim=brToISO(d); 
    addMessage(d); 
    if(selectedAmbiente==='Chromebooks') askQuantity(); 
    else askHorariosAmbiente(); 
  }); 
}
function askDateAmbiente(){ askDate(); }

function askQuantity(){ 
  addMessage('Quantidade de Chromebooks:'); 
  createInput('Quantidade', q=>{ 
    reserva.quantidade=parseInt(q); 
    addMessage(q); 
    askHorarios(); 
  }); 
}

async function askHorarios(){ 
  addMessage('Selecione horários:'); 
  const container=document.createElement('div'); 
  container.classList.add('option-container'); 
  reserva.horariosSelecionados=new Set(); 

  const reservas = await fetchReservas();
  const bloqueiosResp = await fetch(`\${SUPABASE_URL}/rest/v1/bloqueios?select=*`, {headers});
  const bloqueios = await bloqueiosResp.json();

  horarios.forEach(h=>{ 
    let ocupado = 0;
    let max = (selectedAmbiente==='Chromebooks'?MAX_CHROMEBOOKS:MAX_DEFAULT);

    // soma reservas já feitas
    ocupado = reservas
      .filter(r => r.ambiente===selectedAmbiente && r.datafim===reserva.dataFim && (r.horarios||[]).includes(h))
      .reduce((soma,r)=> soma+(r.quantidade||1), 0);

    const bloqueado = bloqueios.some(b => b.datafim===reserva.dataFim && (b.horarios||[]).includes(h));

    const btn=document.createElement('button'); 
    btn.classList.add('option-btn'); 
    btn.innerText=h; 

    if(ocupado >= max || bloqueado){
      btn.classList.add('disabled');
      btn.disabled=true;
    } else {
      btn.onclick=()=>{ 
        if(reserva.horariosSelecionados.has(h)){
          reserva.horariosSelecionados.delete(h); 
          btn.style.backgroundColor='var(--accent)';
        } else {
          reserva.horariosSelecionados.add(h); 
          btn.style.backgroundColor='var(--accent-dark)';
        }
      }; 
    }
    container.appendChild(btn); 
  }); 

  const confirm=document.createElement('button'); 
  confirm.classList.add('option-btn'); 
  confirm.innerText='Confirmar'; 
  confirm.style.backgroundColor='var(--accent-darker)'; 
  confirm.onclick=()=>{ 
    reserva.horarios=Array.from(reserva.horariosSelecionados); 
    confirmReservation(); 
  }; 
  container.appendChild(confirm); 
  messagesEl.appendChild(container); 
  messagesEl.scrollTop=messagesEl.scrollHeight; 
}

function askHorariosAmbiente(){ askHorarios(); }

async function confirmReservation(){ 
  reserva.professor = professor.nome; 
  reserva.cpf = professor.cpf; 
  reserva.telefone = professor.telefone; 
  reserva.email = professor.email; 
  reserva.ambiente = selectedAmbiente; 
  if(reserva.quantidade === 0) reserva.quantidade = 1; 

  const reservas = await fetchReservas();
  const maxPermitido = (selectedAmbiente==='Chromebooks'?MAX_CHROMEBOOKS:MAX_DEFAULT);

  for (let h of reserva.horarios) {
    const ocupados = reservas
      .filter(r => r.ambiente === selectedAmbiente && r.datafim === reserva.dataFim && (r.horarios||[]).includes(h))
      .reduce((soma, r) => soma + (r.quantidade || 1), 0);

    const totalDepois = ocupados + reserva.quantidade;

    if (totalDepois > maxPermitido) {
      addMessage(`❌ Não há disponibilidade no horário ${h} de ${isoToBR(reserva.dataFim)}.\\nDisponíveis: ${maxPermitido - ocupados}`);
      askSelectAmbiente();
      return;
    }

    if (totalDepois === maxPermitido) {
      await saveBloqueio({
        dataFim: reserva.dataFim,
        horarios: [h],
        quantidade: maxPermitido
      });
    }
  }

 await saveReserva(reserva); 
 addMessage('✅ Reserva confirmada!');

 // AQUI está a pergunta que está faltando:
 addMessage('Deseja fazer mais alguma reserva?');

 // Botões
 const container = document.createElement('div');
 container.classList.add('option-container');

 const btnSim = document.createElement('button');
 btnSim.classList.add('option-btn');
 btnSim.innerText = 'Sim';
 btnSim.onclick = () => {
   addMessage('Sim','user');
   askSelectAmbiente();
 };

 const btnNao = document.createElement('button');
 btnNao.classList.add('option-btn');
 btnNao.innerText = 'Não';
 btnNao.onclick = () => {
   addMessage('Não','user');
   resetChat();
 };

 container.appendChild(btnSim);
 container.appendChild(btnNao);

 messagesEl.appendChild(container);
 messagesEl.scrollTop = messagesEl.scrollHeight;

}

function resetChat(){
  messagesEl.innerHTML = '';
  professor = {nome:'', cpf:'', telefone:'', email:''};
  reserva = {quantidade:0, dataFim:'', horarios:[], ambiente:'Chromebooks'};
  state = 0;

  addMessage('Olá, eu sou a Leopoldina, sua assistente virtual. Digite seu CPF para começar:');

  chatInput.disabled = false;
  chatInput.value = '';
  chatInput.placeholder = 'CPF';
  sendBtn.disabled = false;

  sendBtn.onclick = () => {
    if(chatInput.value.trim()==='') return;
    const val = chatInput.value.trim();
    chatInput.value = '';
    chatInput.disabled = true;
    sendBtn.disabled = true;
    cpfInput(val);
  };

  chatInput.focus();
}

addMessage('Olá, eu sou a Leopoldina, sua assistente virtual. Digite seu CPF para começar:');
state=0; createInput('CPF',cpfInput); 
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!sendBtn.disabled){ sendBtn.click(); e.preventDefault(); }});
</script>
</body>
</html>
