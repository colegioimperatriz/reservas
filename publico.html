<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calendário de Reservas - Público — Colégio Imperatriz</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f7;color:#222;margin:0;padding:18px}
  .container{max-width:1100px;margin:0 auto}
  h2{text-align:center}
  .calendar{background:#fff;border-radius:8px;padding:8px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #eee;padding:8px;vertical-align:top;min-height:90px}
  .reserva{display:block;padding:4px 6px;border-radius:6px;margin:4px 0;color:#fff;font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .reserva.bloqueio{background:#555}
  .amb-Chromebooks{background:#1e88e5}
  .amb-Cozinha{background:#f39c12}
  .amb-TeleSala{background:#2e7d32}
  .amb-SalaDeAtendimentoI{background:#8e44ad}
  .amb-SalaDeReuniões{background:#d35400}
  .amb-Carro{background:#6c757d}
  .amb-LabQuímica{background:#00796b}
  .amb-LabFísica{background:#5d4037}
  .amb-LabBiologia{background:#c2185b}
  .amb-SalaDoCTC{background:#3949ab}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h2>Calendário Público de Reservas — Colégio Imperatriz</h2>
  <p class="muted">Visão pública: consulte os horários já reservados antes de fazer sua reserva. Esta tela é somente leitura.</p>
  <div id="calendar" class="calendar">
    <div id="calendarBody"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://oufiieqxyyqnqpcbuyms.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91ZmlpZXF4eXlxbnFwY2J1eW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDMwNDgsImV4cCI6MjA3NDkxOTA0OH0.-4QPA1R5y24daAt-WsZuWc8-2bJxCJGhdTR1nq4RnHc";
const headers = { "Content-Type":"application/json", "apikey":SUPABASE_KEY, "Authorization":`Bearer ${SUPABASE_KEY}` };
const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];

function toArray(val){ if(!val) return []; if(Array.isArray(val)) return val; try{ return JSON.parse(val); }catch(e){ if(typeof val==='string') return val.split(',').map(s=>s.trim()).filter(Boolean); return []; } }

async function fetchJson(url){
  try{
    const r = await fetch(url,{headers});
    if(!r.ok) return [];
    return await r.json();
  }catch(e){ return []; }
}

function isoToBR(iso){ if(!iso) return '---'; const part=(iso||'').split('T')[0]; return part.split('-').reverse().join('/'); }

async function montarPublico(){
  const reservas = await fetchJson(`${SUPABASE_URL}/rest/v1/reservas?select=*`);
  const bloqueios = await fetchJson(`${SUPABASE_URL}/rest/v1/bloqueios?select=*`);
  // vamos exibir próximos 14 dias (hoje + 13)
  const container = document.getElementById('calendarBody');
  container.innerHTML = '';
  const hoje = new Date();
  for(let i=0;i<14;i++){
    const d = new Date(hoje); d.setDate(hoje.getDate()+i);
    const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const card = document.createElement('div');
    card.style.borderBottom='1px solid #eee';
    card.style.padding='8px 0';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = isoToBR(iso);
    card.appendChild(title);

    const items = document.createElement('div');
    // reservas
    reservas.filter(r=> (r.datafim||r.dataFim||'').startsWith(iso)).forEach(r=>{
      toArray(r.horarios).forEach(h=>{
        const amb = r.ambiente || 'Chromebooks';
        const div = document.createElement('div');
        div.classList.add('reserva', 'amb-' + amb.replace(/\s+/g,'').replace(/[^a-zA-Z0-9]/g,''));
        div.textContent = `${h} — ${amb} — ${r.professor || '---'} (${r.quantidade||1})`;
        items.appendChild(div);
      });
    });
    // bloqueios
    bloqueios.filter(b=> (b.datafim||b.dataFim||'').startsWith(iso)).forEach(b=>{
      toArray(b.horarios).forEach(h=>{
        const div = document.createElement('div'); div.classList.add('reserva','bloqueio');
        div.textContent = `${h} — BLOQUEIO — ${b.ambiente || 'Chromebooks'} (${b.quantidade||0})`;
        items.appendChild(div);
      });
    });

    if(items.children.length === 0){
      const none = document.createElement('div'); none.classList.add('muted'); none.textContent = 'Nenhuma reserva neste dia.';
      card.appendChild(none);
    } else {
      card.appendChild(items);
    }

    container.appendChild(card);
  }
}

montarPublico();
</script>
</body>
</html>
